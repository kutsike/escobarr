<%- include('partials/header') %>

<div class="container-fluid p-0">
    <div class="row mb-3">
        <div class="col-6">
            <h1 class="h3">Karakter Yönetimi</h1>
        </div>
        <div class="col-6 text-end">
            <button class="btn btn-primary" onclick="openModal()">+ Yeni Karakter</button>
        </div>
    </div>

    <div class="row">
        <% if (profiles && profiles.length > 0) { %>
            <% profiles.forEach(p => { %>
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0 fw-bold"><%= p.name %></h5>
                        <div>
                            <button class="btn btn-link p-0 me-2" onclick="editProfile('<%= Buffer.from(JSON.stringify(p)).toString('base64') %>')">
                                <i class="bi bi-pencil-square fs-5"></i>
                            </button>
                            <button class="btn btn-link p-0 text-danger" onclick="deleteProfile(<%= p.id %>)">
                                <i class="bi bi-trash fs-5"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <h6 class="text-primary mb-2"><%= p.title %></h6>
                        <p class="small text-muted mb-3"><%= p.short_description %></p>
                        <div class="alert alert-light border small fst-italic mb-2">
                            <i class="bi bi-quote"></i> <%= p.slogan %>
                        </div>
                        <div class="d-grid mt-3">
                            <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#prompt<%= p.id %>">
                                Gizli Görev Detayı
                            </button>
                        </div>
                        <div class="collapse mt-2" id="prompt<%= p.id %>">
                            <div class="card card-body bg-light small p-2">
                                <%= p.prompt_description %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <% }) %>
        <% } else { %>
            <div class="col-12 text-center mt-5">
                <p class="lead text-muted">Henüz karakter eklenmemiş.</p>
            </div>
        <% } %>
    </div>
</div>

<div class="modal fade" id="profileModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Karakter Düzenle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="profileForm">
            <input type="hidden" name="id" id="pid">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Adı Soyadı</label>
                    <input type="text" class="form-control" name="name" id="pname" placeholder="Örn: Demirkan Güçlü" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Ünvanı</label>
                    <input type="text" class="form-control" name="title" id="ptitle" placeholder="Örn: Finans Müdürü" required>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Kısa Tanım (Kişilik)</label>
                <input type="text" class="form-control" name="short_description" id="pdesc" placeholder="Sert, otoriter..." required>
            </div>
            <div class="mb-3">
                <label class="form-label">Slogan (Motto)</label>
                <input type="text" class="form-control" name="slogan" id="pslogan" placeholder="İş bitiriciyiz.">
            </div>
            <div class="mb-3">
                <label class="form-label">AI Prompt (Gizli Görev)</label>
                <textarea class="form-control" name="prompt_description" id="pprompt" rows="4" placeholder="Sen şusun..." required></textarea>
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
        <button type="button" class="btn btn-primary" onclick="saveProfile()">Kaydet</button>
      </div>
    </div>
  </div>
</div>

<script>
    let profileModal;
    document.addEventListener('DOMContentLoaded', function() {
        profileModal = new bootstrap.Modal(document.getElementById('profileModal'));
    });

    function openModal() {
        document.getElementById('profileForm').reset();
        document.getElementById('pid').value = '';
        profileModal.show();
    }

    function editProfile(base64Json) {
        const p = JSON.parse(atob(base64Json));
        document.getElementById('pid').value = p.id;
        document.getElementById('pname').value = p.name;
        document.getElementById('ptitle').value = p.title;
        document.getElementById('pdesc').value = p.short_description;
        document.getElementById('pslogan').value = p.slogan;
        document.getElementById('pprompt').value = p.prompt_description;
        profileModal.show();
    }

    async function saveProfile() {
        const formData = new FormData(document.getElementById('profileForm'));
        const data = Object.fromEntries(formData.entries());
        try {
            const res = await fetch('/api/bot-profiles', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if(result.success) location.reload();
            else alert("Hata: " + result.error);
        } catch(e) { alert("Hata!"); }
    }

    async function deleteProfile(id) {
        if(confirm("Bu karakteri silmek istediğine emin misin?")) {
            await fetch(`/api/bot-profiles/${id}`, { method: 'DELETE' });
            location.reload();
        }
    }
</script>
<%- include('partials/footer') %>