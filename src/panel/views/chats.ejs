<%- include('partials/header', { title, page }) %>

<div class="content-header">
  <h2><i class="fas fa-comments"></i> Sohbetler</h2>
  <div class="header-actions">
    <select class="form-control form-select" id="clientFilter" onchange="filterByClient(this.value)" style="width: auto;">
      <option value="all">Tüm Botlar</option>
      <% clients.forEach(client => { %>
        <option value="<%= client.id %>"><%= client.name || client.id %></option>
      <% }) %>
    </select>
    <button class="btn btn-secondary" onclick="loadChats()">
      <i class="fas fa-sync-alt"></i> Yenile
    </button>
  </div>
</div>

<div class="chat-container">
  <!-- Chat List -->
  <div class="chat-list-panel">
    <div class="search-box">
      <input type="text" id="chatSearch" placeholder="Sohbet ara..." oninput="searchChats(this.value)">
    </div>
    <div class="chat-list" id="chat-list">
      <% if (profiles && profiles.length > 0) { %>
        <% profiles.forEach(p => { %>
          <div class="chat-item" data-chat-id="<%= p.chat_id %>" data-client-id="<%= p.client_id %>" onclick="selectChat('<%= p.chat_id %>', '<%= p.client_id %>')">
            <div class="chat-avatar"><%= (p.full_name || 'İ')[0].toUpperCase() %></div>
            <div class="chat-info">
              <div class="chat-name"><%= p.full_name || 'İsimsiz' %></div>
              <div class="chat-preview"><%= (p.subject || 'Henüz konu yok').substring(0, 40) %></div>
            </div>
            <div class="chat-meta">
              <span class="badge badge-<%= p.status === 'new' ? 'info' : p.status === 'waiting' ? 'warning' : p.status === 'admin' ? 'danger' : 'success' %>"><%= p.status %></span>
            </div>
          </div>
        <% }) %>
      <% } else { %>
        <div class="empty-state">
          <i class="fas fa-inbox"></i>
          <h4>Sohbet Yok</h4>
          <p>Henüz sohbet başlatılmamış.</p>
        </div>
      <% } %>
    </div>
  </div>

  <!-- Chat Detail -->
  <div class="chat-detail-panel" id="chat-detail">
    <div class="empty-chat">
      <i class="fas fa-comments"></i>
      <h3>Sohbet Seçin</h3>
      <p>Mesajları görüntülemek için soldan bir sohbet seçin.</p>
    </div>
    
    <div id="chat-content" style="display: none; flex-direction: column; height: 100%;">
      <!-- Chat Header -->
      <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <strong id="profile-name">-</strong>
          <span class="text-muted" id="profile-phone" style="margin-left: 0.5rem;">-</span>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-secondary" onclick="takeoverChat(window.activeChatId)">
            <i class="fas fa-hand-paper"></i> Devral
          </button>
          <button class="btn btn-sm btn-secondary" onclick="releaseChat(window.activeChatId)">
            <i class="fas fa-robot"></i> Bota Bırak
          </button>
        </div>
      </div>
      
      <!-- Messages -->
      <div class="message-container" id="message-container">
        <!-- Mesajlar buraya yüklenecek -->
      </div>
      
      <!-- Message Input -->
      <form class="message-input-area" id="message-form">
        <input type="text" id="message-input" placeholder="Mesaj yazın..." autocomplete="off">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-paper-plane"></i>
        </button>
      </form>
    </div>
  </div>
</div>

<%- include('partials/footer') %>
